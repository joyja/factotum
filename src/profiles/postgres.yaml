config:
  user.user-data: |
    #cloud-config
    phone_home:
      url: http://_gateway:4000/phone-home/$INSTANCE_ID/
      post:
        - hostname
      tries: 10
    packages:
      - postgresql
    write_files:
      - path: /root/pg_hba.conf
        content: |
          local   all             postgres                                peer
          # TYPE  DATABASE        USER            ADDRESS                 METHOD
          # "local" is for Unix domain socket connections only
          local   all             all                                     peer
          # IPv4 local connections:
          host    all             all             127.0.0.1/32            md5
          # IPv6 local connections:
          host    all             all             ::1/128                 md5
          # Allow replication connections from localhost, by a user with the
          # replication privilege.
          local   replication     all                                     peer
          host    replication     all             127.0.0.1/32            md5
          host    replication     all             ::1/128                 md5
          host    all             all             0.0.0.0                 md5
      - path: /root/postgresql.conf
        content: |
          data_directory = '/var/lib/postgresql/12/main'		# use data in another directory
          hba_file = '/etc/postgresql/12/main/pg_hba.conf'	# host-based authentication file
          ident_file = '/etc/postgresql/12/main/pg_ident.conf'	# ident configuration file

          external_pid_file = '/var/run/postgresql/12-main.pid'			# write an extra PID file

          listen_addresses = '*'		# what IP address(es) to listen on;
          port = 5432				# (change requires restart)
          max_connections = 100			# (change requires restart)
          unix_socket_directories = '/var/run/postgresql'	# comma-separated list of directories

          ssl = on
          ssl_cert_file = '/etc/ssl/certs/ssl-cert-snakeoil.pem'
          ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'

          shared_buffers = 128MB			# min 128kB

          dynamic_shared_memory_type = posix	# the default is the first option

          max_wal_size = 1GB
          min_wal_size = 80MB

          log_line_prefix = '%m [%p] %q%u@%d '		# special values:
          log_timezone = 'Etc/UTC'

          cluster_name = '12/main'			# added to process titles if nonempty

          stats_temp_directory = '/var/run/postgresql/12-main.pg_stat_tmp'

          datestyle = 'iso, mdy'

          timezone = 'Etc/UTC'

          lc_messages = 'C.UTF-8'			# locale for system error message
          lc_monetary = 'C.UTF-8'			# locale for monetary formatting
          lc_numeric = 'C.UTF-8'			# locale for number formatting
          lc_time = 'C.UTF-8'				# locale for time formatting

          default_text_search_config = 'pg_catalog.english'

          include_dir = 'conf.d'			# include files ending in '.conf' from
      runcmd:
        - mv /root/postgresql.conf /etc/postgresql/12/main/
        - mv /root/pg_hba.conf /etc/postgresql/12/main/
description: Default LXD profile
devices: {}
name: postgres